!function(){"use strict";angular.module("loc8rApp",["ngRoute"]).config(["$routeProvider","$locationProvider",function(o,t){t.hashPrefix(""),o.when("/",{templateUrl:"views/home.html",controller:"homeCtrl",controllerAs:"vm"}).when("/admin/add",{templateUrl:"views/admin-add.html",controller:"adminCtrl",controllerAs:"vm",resolve:{adminCheck:["authService","$location",function(o,t){o.isAdmin()||t.path("/")}]}}).when("/home",{templateUrl:"views/home.html",controller:"homeCtrl",controllerAs:"vm"}).when("/login",{templateUrl:"views/signin.html",controller:"signinCtrl",controllerAs:"vm"}).when("/register",{templateUrl:"views/register.html",controller:"registerCtrl",controllerAs:"vm"}).when("/about",{templateUrl:"views/about.html",controller:"aboutCtrl",controllerAs:"vm"}).when("/location/add",{templateUrl:"views/location-form.html",controller:"locationFormCtrl",controllerAs:"vm",resolve:{adminCheck:["authService","$location",function(o,t){o.isAdmin()||t.path("/")}]}}).when("/location/:locationid",{templateUrl:"views/location-detail.html",controller:"locationDetailCtrl",controllerAs:"vm"}).when("/location/:locationid/edit",{templateUrl:"views/location-form.html",controller:"locationFormCtrl",controllerAs:"vm",resolve:{adminCheck:["authService","$location",function(o,t){o.isAdmin()||t.path("/")}]}}).when("/location/:locationid/review/add",{templateUrl:"views/review-form.html",controller:"reviewFormCtrl",controllerAs:"vm"}).when("/location/:locationid/review/:reviewid/edit",{templateUrl:"views/review-form.html",controller:"reviewFormCtrl",controllerAs:"vm"}).otherwise({redirectTo:"/"})}])}(),function(){"use strict";function o(o){return{request:function(t){var e=o.getToken();return e&&(t.headers=t.headers||{},t.headers.Authorization="Bearer "+e),t}}}angular.module("loc8rApp").factory("authInterceptor",o).config(["$httpProvider",function(o){o.interceptors.push("authInterceptor")}]),o.$inject=["authService"]}(),function(){"use strict";function o(o){var t=o.localStorage,e="loc8r_token";this.saveToken=function(o){o?t.setItem(e,o):t.removeItem(e)},this.getToken=function(){return t.getItem(e)},this.logout=function(){t.removeItem(e)},this.parseToken=function(){var o=this.getToken();if(!o)return null;try{var t=o.split(".")[1];return t=t.replace(/-/g,"+").replace(/_/g,"/"),t=decodeURIComponent(atob(t).split("").map(function(o){return"%"+("00"+o.charCodeAt(0).toString(16)).slice(-2)}).join("")),JSON.parse(t)}catch(o){return null}},this.getRole=function(){var o=this.parseToken();return o&&o.role?o.role:null},this.isAdmin=function(){return"admin"===this.getRole()},this.isAuthenticated=function(){return!!this.getToken()}}angular.module("loc8rApp").service("authService",o),o.$inject=["$window"]}(),function(){"use strict";angular.module("loc8rApp").service("loc8rData",["$http","$q",function(o,t){var e="/api";this.getLocations=function(){return o.get(e+"/locations").catch(function(){return o.get("/data/locations.json")})},this.getLocationById=function(t){return o.get(e+"/locations/"+t).catch(function(){return o.get("/data/locations.json").then(function(o){return{data:o.data.find(o=>o._id===t)}})})},this.addLocation=function(n){return o.post(e+"/locations",n).catch(function(){return t.resolve({data:n})})},this.updateLocation=function(n,r){return o.put(e+"/locations/"+n,r).catch(function(){return t.resolve({data:r})})},this.deleteLocation=function(n){return o.delete(e+"/locations/"+n).catch(function(){return t.resolve({})})},this.addReview=function(n,r){return o.post(e+"/locations/"+n+"/reviews",r).catch(function(){return t.resolve({data:r})})},this.getReview=function(n,r){return o.get(e+"/locations/"+n+"/reviews/"+r).catch(function(){return t.reject({message:"Review not found (mock)"})})},this.updateReview=function(n,r,a){return o.put(e+"/locations/"+n+"/reviews/"+r,a).catch(function(){return t.resolve({data:a})})},this.deleteReview=function(n,r){return o.delete(e+"/locations/"+n+"/reviews/"+r).catch(function(){return t.resolve({})})},this.getLocationsByCoords=function(t,n,r){return o.get(e+"/locations",{params:{lat:t,lng:n,maxDistance:r}}).catch(function(){return o.get("/data/locations.json").then(function(o){return{data:(o.data||[]).filter(function(o){if(!o.coords||!Array.isArray(o.coords.coordinates))return!1;var e=o.coords.coordinates[0],a=o.coords.coordinates[1];return 111e3*Math.sqrt(Math.pow(a-t,2)+Math.pow(e-n,2))<=r})}})})},this.getNearbyRestaurants=function(t,n,r){return o.get(e+"/locations/nearby",{params:{lat:t,lng:n,maxDistance:r}}).catch(function(){return o.get("/data/locations.json").then(function(o){var e=Array.isArray(o.data)?o.data:o.data.locations||[];if(!e)return{data:[]};return{data:e.map(function(o){var e=o.coords&&o.coords.coordinates?o.coords.coordinates:o.coordinates&&o.coordinates.coordinates?o.coordinates.coordinates:o.location&&o.location.coordinates?o.location.coordinates:null;if(!e)return null;var r=(e[1]-t)*Math.PI/180,a=(e[0]-n)*Math.PI/180,i=Math.sin(r/2)*Math.sin(r/2)+Math.cos(t*Math.PI/180)*Math.cos(e[1]*Math.PI/180)*Math.sin(a/2)*Math.sin(a/2),c=2*Math.atan2(Math.sqrt(i),Math.sqrt(1-i));return o.distance=6371*c*1e3,o}).filter(Boolean).filter(function(o){return o.distance<=r})}})})}}])}(),function(){"use strict";angular.module("loc8rApp").directive("leafletMap",["$timeout",function(o){return{restrict:"E",scope:{vmCtrl:"=",locations:"="},template:'<div class="map-container" style="width:100%; height:100%; min-height:300px;"></div>',link:function(o,t){var e=t[0].children[0],n=null,r=null,a=L.icon({iconUrl:"https://cdn-icons-png.flaticon.com/512/684/684908.png",iconSize:[32,32],iconAnchor:[16,32]}),i=L.icon({iconUrl:"https://cdn-icons-png.flaticon.com/512/149/149059.png",iconSize:[32,32],iconAnchor:[16,32]}),c=L.icon({iconUrl:"https://cdn-icons-png.flaticon.com/512/684/684908.png",iconSize:[40,40],iconAnchor:[20,40],className:"marker-highlight"});function s(t,s,l){var u;if(n?r.clearLayers():(u=[t,s],n=L.map(e).setView(u,13),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"&copy; OpenStreetMap contributors"}).addTo(n),r=L.layerGroup().addTo(n)),t&&s&&L.marker([t,s],{icon:a}).bindPopup("You are here").addTo(r),l&&l.length&&l.forEach(o=>{var t=o.coords?.coordinates||o.coordinates?.coordinates||o.location?.coordinates;if(t){var e=L.marker([t[1],t[0]],{icon:i}).bindPopup("<b>"+(o.name||"")+"</b><br>"+(o.address||""));e.on("click",function(){r.eachLayer(o=>{o.setIcon&&o.setIcon(i),o.closePopup&&o.closePopup()}),e.setIcon(c),e.openPopup()}),e.addTo(r),o._marker=e}}),o.vmCtrl){var d=o.vmCtrl.location||null,h=d?.coords?.coordinates?d.coords.coordinates[1]:o.vmCtrl.lat||t,m=d?.coords?.coordinates?d.coords.coordinates[0]:o.vmCtrl.lng||s;if(h&&m&&d){var g=L.marker([h,m],{draggable:!0,icon:a}).addTo(r).bindPopup("Drag to set location");g.on("dragend",function(){var t=g.getLatLng();d.coords={type:"Point",coordinates:[t.lng,t.lat]},o.$apply()}),o.vmCtrl._marker=g,n.setView([h,m],13)}}}o.$watchGroup(["vmCtrl","locations"],function(o){var t=o[0],e=o[1]||[],n=t?.location?.coords?.coordinates?t.location.coords.coordinates[1]:t?.lat,r=t?.location?.coords?.coordinates?t.location.coords.coordinates[0]:t?.lng;n&&r&&s(n,r,e)},!0),o.$on("map:updateMarkers",function(o,t){t.userLocation&&t.restaurants&&s(t.userLocation.lat,t.userLocation.lng,t.restaurants)})}}}])}(),function(){"use strict";angular.module("loc8rApp").controller("aboutCtrl",[function(){this.pageHeader={title:"About Loc8r"},this.content="Loc8r is a demo app that lists places with wifi. This is a small single page AngularJS app used for teaching and prototyping."}])}(),function(){"use strict";angular.module("loc8rApp").controller("adminCtrl",["$http","authService",function(o,t){var e=this;e.username="",e.password="",e.message="",e.error="",e.loading=!1,e.addAdmin=function(){e.message=e.error="",e.username&&e.password?(e.loading=!0,o.post("/api/admin/add",{username:e.username,password:e.password}).then(function(o){e.loading=!1,e.message=o.data.message||"Admin created successfully",e.username=e.password=""}).catch(function(o){e.loading=!1,e.error=o.data&&o.data.message||"Error adding admin",console.error("Add admin error:",o)})):e.error="Username and password are required"}}])}(),function(){"use strict";angular.module("loc8rApp").controller("homeCtrl",["$scope","loc8rData",function(o,t){var e=this;e.distance=5e3,e.locations=[],e.message="",e.lat=null,e.lng=null;var n=io();e.requestNearby=function(){e.lat&&e.lng&&n.emit("getNearby",{lng:e.lng,lat:e.lat,maxDistance:parseInt(e.distance,10)})},e.focusOn=function(o){o&&o._marker&&e._map&&(e._map.eachLayer(function(o){o.closePopup&&o.closePopup()}),e._map.flyTo(o._marker.getLatLng(),16,{duration:1.2}),o._marker.openPopup(),e._highlightedMarker&&e._highlightedMarker!==o._marker&&e._highlightedMarker.setIcon(e._restaurantIcon),o._marker.setIcon(e._highlightIcon),e._highlightedMarker=o._marker)},n.on("connect",function(){o.$applyAsync(()=>{e.message=""})}),n.on("nearbyResults",function(t){o.$applyAsync(function(){e.locations=Array.isArray(t)?t:[],e.message=e.locations.length?"":"No restaurants found",o.$broadcast("map:updateMarkers",{userLocation:{lat:e.lat,lng:e.lng},restaurants:e.locations})})}),n.on("errorMsg",function(t){o.$applyAsync(function(){e.message=t&&t.error||"Failed to fetch nearby restaurants"})}),o.$watch(()=>e.distance,function(o,t){o!==t&&(o<1e3&&(e.distance=1e3),o>25e4&&(e.distance=25e4),n.connected&&e.requestNearby())}),navigator.geolocation?navigator.geolocation.getCurrentPosition(function(r){o.$apply(function(){e.lat=r.coords.latitude,e.lng=r.coords.longitude,n.connected?e.requestNearby():t.getNearbyRestaurants(e.lat,e.lng,e.distance).then(t=>{e.locations=t.data||[],o.$broadcast("map:updateMarkers",{userLocation:{lat:e.lat,lng:e.lng},restaurants:e.locations})}).catch(()=>e.message="Unable to fetch nearby restaurants")})},function(){e.message="Enable GPS and allow location permission"},{enableHighAccuracy:!0}):e.message="Geolocation not supported"}])}(),function(){"use strict";angular.module("loc8rApp").controller("locationDetailCtrl",["$routeParams","loc8rData",function(o,t){var e=this;e.locationid=o.locationid,e.location=null,e.message="",e.formError="",e.getLocation=function(){t.getLocationById(e.locationid).then(function(o){e.location=o.data}).catch(function(o){e.message="Sorry, something went wrong",console.error(o)})},e.addReview=function(){e.newReview&&e.newReview.author&&e.newReview.rating&&e.newReview.reviewText?(e.formError="",t.submitReview(e.locationid,e.newReview).then(function(){e.newReview={},e.getLocation()}).catch(function(o){e.formError="Sorry, something went wrong",console.error(o)})):e.formError="All fields required"},e.deleteReview=function(o){confirm("Are you sure you want to delete this review?")&&t.deleteReview(e.locationid,o).then(function(){e.getLocation()}).catch(function(o){e.message="Error deleting review",console.error(o)})},e.getLocation()}])}(),function(){"use strict";angular.module("loc8rApp").controller("locationFormCtrl",["$routeParams","loc8rData","$location",function(o,t,e){var n=this;n.isEdit=!!o.locationid,n.location={name:"",address:"",facilities:"",rating:0,coords:{type:"Point",coordinates:[78.486671,17.385044]},openingTimes:[]},n.message="",n.isEdit&&t.getLocationById(o.locationid).then(function(o){n.location=o.data,n.location.coords&&Array.isArray(n.location.coords.coordinates)&&2===n.location.coords.coordinates.length||(n.location.coords={type:"Point",coordinates:[78.486671,17.385044]}),Array.isArray(n.location.openingTimes)||(n.location.openingTimes=[])}).catch(function(o){n.message="Error loading location",console.error(o)}),n.addOpeningTime=function(){n.location.openingTimes.push({days:"",opening:"",closing:"",closed:!1})},n.removeOpeningTime=function(o){n.location.openingTimes.splice(o,1)},n.saveLocation=function(){if(!n.location.name||!n.location.address)return void(n.message="Name and Address are required");if(!n.location.coords||!Array.isArray(n.location.coords.coordinates)||2!==n.location.coords.coordinates.length)return void(n.message="Please select a location on the map");const r=parseFloat(n.location.coords.coordinates[0]),a=parseFloat(n.location.coords.coordinates[1]);if(isNaN(a)||isNaN(r))return void(n.message="Invalid coordinates. Please pin the location on the map.");const i=Array.isArray(n.location.facilities)?n.location.facilities.join(","):n.location.facilities||"",c=Array.isArray(n.location.openingTimes)?n.location.openingTimes:[],s={name:n.location.name,address:n.location.address,rating:n.location.rating||0,facilities:i,lat:a,lng:r,openingTimes:c};(n.isEdit?t.updateLocation(o.locationid,s):t.addLocation(s)).then(()=>{e.path("/")}).catch(o=>{n.message="Error saving location",console.error(o)})}}])}(),function(){"use strict";function o(o,t){var e=this;e.isAuthenticated=function(){return o.isAuthenticated()},e.isAdmin=function(){return o.isAdmin()},e.logout=function(){o.logout(),t.path("/signin")},e.username=function(){var t=o.parseToken();return t&&t.username?t.username:null}}angular.module("loc8rApp").controller("navCtrl",o),o.$inject=["authService","$location"]}(),function(){"use strict";function o(o,t,e){var n=this;n.user={},n.error=null,n.message=null,n.loading=!1,n.register=function(){n.error=n.message=null,n.user.username&&n.user.password?(n.loading=!0,n.user.role="user",o.post("/api/register",n.user).then(function(o){if(n.loading=!1,o.data&&o.data.token)return e.saveToken(o.data.token),void t.path("/");n.message=o.data&&o.data.message?o.data.message:"Registration successful. Please sign in.",n.user={}}).catch(function(o){n.loading=!1,n.error=o.data&&o.data.message||"Registration failed",console.error("Register error",o)})):n.error="Username and password are required."}}angular.module("loc8rApp").controller("registerCtrl",o),o.$inject=["$http","$location","authService"]}(),function(){"use strict";angular.module("loc8rApp").controller("reviewFormCtrl",["$routeParams","loc8rData","$location",function(o,t,e){var n=this;n.locationid=o.locationid,n.reviewid=o.reviewid,n.review={},n.message="",n.reviewid&&t.getReview(n.locationid,n.reviewid).then(function(o){n.review=o.data}).catch(function(o){n.message="Error loading review",console.error(o)}),n.saveReview=function(){n.review.author&&n.review.reviewText?n.reviewid?t.updateReview(n.locationid,n.reviewid,n.review).then(function(){e.path("/location/"+n.locationid)}).catch(function(o){n.message="Error updating review",console.error(o)}):t.addReview(n.locationid,n.review).then(function(){e.path("/location/"+n.locationid)}).catch(function(o){n.message="Error adding review",console.error(o)}):n.message="All fields are required"}}])}(),function(){"use strict";function o(o,t,e){var n=this;n.user={},n.error=null,n.login=function(){n.error=null,o.post("/api/login",n.user).then(function(o){o.data&&o.data.token?(e.saveToken(o.data.token),t.path("/")):n.error="No token received"}).catch(function(o){n.error=o.data&&o.data.message||"Login failed"})}}angular.module("loc8rApp").controller("signinCtrl",o),o.$inject=["$http","$location","authService"]}();